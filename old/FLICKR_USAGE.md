# Flickr 圖片爬取使用說明

## 主要改進 🚀

1. **使用正式 Flickr API**: 直接使用 flickrapi 套件，避免網頁爬取的不穩定性
2. **不添加額外文字**: 搜尋時只使用景點原始名稱，不加上 "Taiwan" 或 "台灣"
3. **智能多策略搜尋**: 使用4種不同搜尋策略獲取最相關圖片
4. **相關性排序系統**: 根據多個因素計算圖片相關性分數
5. **圖片品質優先**: 優先下載高解析度圖片 (url_o > url_c > url_m)

## ✨ 新功能：智能排序系統

### 多策略搜尋
程式使用4種不同的搜尋策略來確保獲取最相關的圖片：

1. **相關性排序** (權重: 1.0) - 使用 Flickr 的相關性演算法
2. **趣味性排序** (權重: 0.8) - 優先選擇高品質、受歡迎的圖片
3. **地理標籤搜尋** (權重: 0.9) - 搜尋有地理標籤的圖片，可能更準確
4. **標籤搜尋** (權重: 0.7) - 根據景點名稱作為標籤搜尋

### 相關性評分系統
程式會為每張圖片計算相關性分數，考慮以下因素：

- **策略權重** (0-100分): 根據搜尋策略的重要性
- **觀看次數** (0-50分): 熱門圖片通常品質更好
- **地理標籤** (+20分): 有GPS座標的圖片更可能是實地拍攝
- **標籤豐富度** (+2分/標籤): 標籤越多描述越詳細
- **拍攝時間** (+10分): 近10年內拍攝的圖片加分

### 檔案命名
下載的圖片檔名包含相關性資訊：
```
景點名稱_序號_score分數_搜尋策略.jpg
例如: 日月潭_1_score156_相關性排序.jpg
```

## 可用的排序方法

根據 Flickr API 文檔，支援以下排序選項：

### 1. 相關性排序 (relevance)
- **最推薦**: 根據 Flickr 演算法找出最相關的圖片
- 適合：想要與景點最相關的圖片

### 2. 趣味性排序 (interestingness-desc/asc)
- **高品質**: Flickr 根據觀看數、評論、收藏等計算的"趣味性"
- 適合：想要高品質、受歡迎的圖片

### 3. 日期排序 (date-posted-desc/asc, date-taken-desc/asc)
- **時間性**: 按上傳日期或拍攝日期排序
- 適合：想要最新或最舊的圖片

### 4. 地理排序 (距離優先，需要座標)
- **位置準確**: 根據與指定座標的距離排序
- 適合：有確切GPS座標的景點

## 設置步驟

1. **申請 Flickr API 憑證**:
   - 前往 https://www.flickr.com/services/apps/create/apply
   - 選擇 "Apply for a non-commercial key"
   - 獲取 API Key 和 API Secret

2. **設置環境變數**:
   在專案根目錄或 Data_F1000 目錄建立 `.env` 檔案：
   ```
   FLICKR_API_KEY=你的API_KEY
   FLICKR_API_SECRET=你的API_SECRET
   ```

   或者使用相容性命名：
   ```
   FLICKER_API_KEY=你的API_KEY
   FLICKER_API_SECRET=你的API_SECRET
   ```

3. **執行程式**:
   ```bash
   cd Data_F1000
   python flickr_image_scraper.py
   ```

## 程式特色

- **智能多策略**: 自動結合4種搜尋策略
- **自動去重**: 移除重複的圖片
- **相關性排序**: 按計算出的相關性分數排序
- **智能跳過**: 如果景點資料夾已有足夠圖片，會自動跳過
- **進度顯示**: 使用 tqdm 顯示每個景點的下載進度
- **錯誤處理**: 完善的錯誤處理機制，單張圖片下載失敗不會影響其他圖片
- **延遲機制**: 內建隨機延遲，避免 API 請求過快

## 輸出結構

```
Flickr_image_data/
├── 景點1/
│   ├── 景點1_1_score156_相關性排序.jpg
│   ├── 景點1_2_score142_趣味性排序.jpg
│   ├── 景點1_3_score138_地理標籤+相關性.jpg
│   └── ...
├── 景點2/
│   ├── 景點2_1_score160_相關性排序.jpg
│   └── ...
└── ...
```

## 參數設定

### 基本參數
```python
# 在 main() 函數中可調整：
scraper.process_csv_file(
    csv_file_path, 
    max_images_per_attraction=100,  # 每個景點圖片數量
    use_smart_search=True          # 是否使用智能搜尋
)
```

### 使用傳統搜尋
如果想使用原始的單一策略搜尋：
```python
scraper.process_csv_file(
    csv_file_path, 
    max_images_per_attraction=100, 
    use_smart_search=False  # 使用傳統相關性搜尋
)
```

### 自定義策略權重
可在 `search_photos_with_multiple_strategies` 方法中調整各策略的權重：
```python
strategies = [
    {
        'text': attraction_name,
        'sort': 'relevance',
        'weight': 1.2,  # 增加相關性搜尋的權重
        'description': '相關性排序'
    },
    # ... 其他策略
]
```

## 進階設定選項

### 1. 僅搜尋有地理標籤的圖片
```python
# 在搜尋參數中添加
'has_geo': '1'
```

### 2. 限制拍攝日期範圍
```python
'min_taken_date': '2020-01-01 00:00:00',
'max_taken_date': '2024-12-31 23:59:59'
```

### 3. 指定圖片授權類型
```python
'license': '4,6,7'  # Creative Commons 授權
```

### 4. 安全搜尋等級
```python
'safe_search': 1  # 1=安全, 2=中等, 3=限制級
```

## 注意事項

- 確保有足夠的磁碟空間（每個景點約 50-200MB）
- Flickr API 有每小時請求限制，大量爬取時請注意
- 智能搜尋會使用更多 API 請求，但能獲得更相關的圖片
- 如果網路不穩定，程式會自動重試並記錄錯誤
- 圖片檔名包含相關性分數，方便後續篩選

## 效果比較

**傳統搜尋** vs **智能多策略搜尋**：

| 特性 | 傳統搜尋 | 智能搜尋 |
|------|----------|----------|
| API 請求數 | 少 | 多 (4倍) |
| 圖片相關性 | 中等 | 高 |
| 圖片品質 | 不確定 | 較佳 |
| 下載速度 | 快 | 較慢 |
| 推薦使用 | 快速測試 | 正式使用 | 